services:
  clickhouse:
    image: clickhouse/clickhouse-server:25.8
    environment:
      CLICKHOUSE_DB: default
      CLICKHOUSE_USER: mewroo
      CLICKHOUSE_PASSWORD: mewroo
    ports:
      - "8123:8123" # HTTP
      - "9000:9000" # Native (optional)
    volumes:
      - ch_data:/var/lib/clickhouse
      - ./backend/db_clickhouse/init:/docker-entrypoint-initdb.d:ro
      - ./backend/db_clickhouse/data:/data:ro
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:8123/ping | grep -q Ok"]
      interval: 2s
      timeout: 2s
      retries: 30

  ch-ui:
    image: ghcr.io/caioricciuti/ch-ui:latest
    restart: always
    ports:
      - "5521:5521"
    depends_on:
      clickhouse:
        condition: service_healthy
    environment:
      # Core ClickHouse Configuration
      VITE_CLICKHOUSE_URL: "http://localhost:8123"
      VITE_CLICKHOUSE_USER: "mewroo"
      VITE_CLICKHOUSE_PASS: "mewroo"

      # Optional: Advanced Features
      VITE_CLICKHOUSE_USE_ADVANCED: "false"
      VITE_CLICKHOUSE_CUSTOM_PATH: ""
      VITE_CLICKHOUSE_REQUEST_TIMEOUT: "30000"

      # Optional: Reverse Proxy Support
      VITE_BASE_PATH: "/"

  ingest_bootstrap:
    profiles: ["ingest"]
    build:
      context: ./backend
    depends_on:
      clickhouse:
        condition: service_healthy
    environment:
      CLICKHOUSE_HOST: clickhouse
      CLICKHOUSE_HTTP_PORT: "8123"
      CLICKHOUSE_DATABASE: default
      CLICKHOUSE_USER: mewroo
      CLICKHOUSE_PASSWORD: mewroo
    command: >
      bash -lc "
        python -m app.ingest.ingest_dim_industry &&
        python -m app.ingest.ingest_industry_membership &&
        python -m app.ingest.ingest_fact_market_cap &&
        python -m app.ingest.ingest_fact_stock_prices
      "
    restart: "no"

  jupyter:
    image: quay.io/jupyter/datascience-notebook:python-3.13
    ports:
      - "8888:8888"
    volumes:
      - ./notebooks:/home/jovyan/work
    environment:
      # helps with permissions when writing notebooks to ./notebooks on host
      CHOWN_HOME: "yes"
      CHOWN_HOME_OPTS: "-R"
      # optional: make notebooks show logs immediately
      PYTHONUNBUFFERED: "1"
    depends_on:
      clickhouse:
        condition: service_healthy
    command: >
      bash -lc "
      pip install --no-cache-dir yfinance clickhouse-connect &&
      start-notebook.py --NotebookApp.token='' --NotebookApp.password='' --NotebookApp.allow_origin='*'
      "

  backend:
    build:
      context: ./backend
    ports:
      - "8000:8000"
    volumes:
      - ./backend:/app
    environment:
      CLICKHOUSE_HOST: clickhouse
      CLICKHOUSE_HTTP_PORT: "8123"
      CLICKHOUSE_DATABASE: default
      CLICKHOUSE_USER: mewroo
      CLICKHOUSE_PASSWORD: mewroo
    depends_on:
      clickhouse:
        condition: service_healthy
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload

  frontend:
    build:
      context: ./frontend
    ports:
      - "5173:5173"
    volumes:
      - ./frontend:/app
      - /app/node_modules
    depends_on:
      - backend
    environment:
      # Helps Windows + Docker file watching
      CHOKIDAR_USEPOLLING: "true"
      WATCHPACK_POLLING: "true"

volumes:
  ch_data:
